<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8"/>
    <title>Outils de fichiers offline (ZIP local + images protégées)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
      :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --primary:#22c55e; --secondary:#334155; }
      * { box-sizing: border-box; }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: linear-gradient(135deg,#0f172a,#1f2937); color: var(--text); }
      .container { max-width: 900px; margin: 32px auto; background: var(--card); padding: 24px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
      h1,h2 { margin-top:0; color:#fff; }
      section { margin-top:24px; padding-top:12px; border-top:1px solid #222; }
      label { display:block; margin:12px 0 6px; color:var(--muted); }
      input[type="file"], input[type="password"], input[type="text"] { width:100%; background:#0b1220; color:var(--text); border:1px solid #1f2937; border-radius:8px; padding:10px; }
      .btn { display:inline-block; margin-top:14px; padding:10px 16px; background: var(--primary); color:#0b1220; border:none; border-radius:8px; cursor:pointer; font-weight:600; text-decoration:none; }
      .btn:hover { filter:brightness(1.1); }
      .btn-secondary { background: var(--secondary); color:#fff; }
      .note { color:var(--muted); font-size:0.95rem; }
      .card { background:#0b1220; border:1px solid #1f2937; border-radius:8px; padding:12px; margin-top:12px; }
      ul { padding-left:20px; }
      img { max-width:100%; height:auto; border-radius:8px; }
      .id-box { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#0b1220; border:1px dashed #334155; border-radius:8px; padding:10px; margin-top:8px; color:#93c5fd; word-break:break-all; }
      .warn { background:#3b82f61a; border:1px solid #3b82f6; color:#bfdbfe; border-radius:8px; padding:10px; margin-top:12px; }
      .error { color:#fca5a5; }
      .mode { margin:8px 0; font-size:0.95rem; }
      code.inline { background:#0b1220; padding:2px 6px; border-radius:6px; border:1px solid #334155; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Outils de fichiers (offline)</h1>
      <p class="note">Sa a mache san Entènèt: “Archive locale” pou compresser/décompresser, ak imaj pwoteje pa mot de pase.</p>
      <div id="envMode" class="mode"></div>

      <section>
        <h2>Compresser des fichiers</h2>
        <label for="zipFiles"><strong>Choisir des fichiers à compresser:</strong></label>
        <input type="file" id="zipFiles" multiple/>
        <button class="btn" id="makeZipBtn" type="button">Compresser et télécharger</button>
        <div id="zipStatus" class="card"></div>
      </section>

      <section>
        <h2>Décompresser une archive</h2>
        <label for="zipInput"><strong>Choisir un fichier d’archive:</strong></label>
        <input type="file" id="zipInput" accept=".zip,.json"/>
        <button class="btn" id="unzipBtn" type="button">Décompresser et afficher</button>
        <div id="unzipResult" class="card"></div>
        <p class="note">Archive locale (.zip JSON) kreye pa sit sa a ap rekonèt otomatikman.</p>
      </section>

      <section>
        <h2>Téléverser une image protégée par mot de passe</h2>
        <label for="protImage"><strong>Choisir une image:</strong></label>
        <input type="file" id="protImage" accept="image/*"/>
        <label for="protPwd"><strong>Définir un mot de passe:</strong></label>
        <input type="password" id="protPwd" placeholder="Mot de passe"/>
        <button class="btn" id="saveProtBtn" type="button">Téléverser (local) et protéger</button>
        <div id="protStatus" class="card"></div>
        <div class="warn">Conserve l’ID d’accès et le mot de passe. San yo, ou pap ka wè imaj la.</div>
      </section>

      <section>
        <h2>Voir une image protégée</h2>
        <label for="viewId"><strong>Entrer l’ID d’accès:</strong></label>
        <input type="text" id="viewId" placeholder="ID affiché après le téléversement"/>
        <label for="viewPwd"><strong>Entrer le mot de passe:</strong></label>
        <input type="password" id="viewPwd" placeholder="Mot de passe"/>
        <button class="btn" id="viewBtn" type="button">Vérifier et afficher</button>
        <div id="viewResult" class="card"></div>
      </section>
    </div>

    <script>
      // ===== Utils =====
      const $ = (id) => document.getElementById(id);
      const text = (el, msg) => { el.textContent = msg; };
      const html = (el, msg) => { el.innerHTML = msg; };
      const bufToHex = (buffer) => Array.from(new Uint8Array(buffer)).map(b=>b.toString(16).padStart(2,'0')).join('');
      const randomId = () => ([1,2,3,4].map(() => Math.random().toString(36).slice(2)).join('-'));
      function saveBlob(blob, name) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = name; a.style.display='none';
        document.body.appendChild(a); a.click();
        setTimeout(() => { URL.revokeObjectURL(url); document.body.removeChild(a); }, 500);
      }
      async function hashPassword(pwd) {
        const enc = new TextEncoder();
        if (crypto && crypto.subtle) {
          try { const digest = await crypto.subtle.digest('SHA-256', enc.encode(pwd)); return bufToHex(digest); } catch(_) {}
        }
        let h=0; for (let i=0;i<pwd.length;i++){ h=(h<<5)-h+pwd.charCodeAt(i); h|=0; } return 'fallback-'+Math.abs(h).toString(16);
      }
      function updateEnvMode() {
        const parts = [];
        parts.push('Mode ZIP: Archive locale (offline)');
        parts.push('Téléchargement: Lien direct');
        parts.push('IndexedDB: ' + (('indexedDB' in window) ? 'disponible' : 'indisponible → localStorage'));
        parts.push('crypto.subtle: ' + ((crypto && crypto.subtle) ? 'disponible' : 'fallback'));
        $('envMode').innerHTML = parts.map(p => '<span>'+p+'</span>').join(' • ');
      }
      updateEnvMode();

      // ===== Dépôt (IndexedDB → fallback localStorage) =====
      const DB_NAME = 'imagesProtegeesDB';
      const STORE_NAME = 'images';
      let db = null;
      let storageMode = 'indexeddb';

      function openDB() {
        return new Promise((resolve) => {
          if (!window.indexedDB) { storageMode = 'localstorage'; return resolve(null); }
          const req = indexedDB.open(DB_NAME, 1);
          req.onupgradeneeded = (e) => {
            const d = e.target.result;
            if (!d.objectStoreNames.contains(STORENAME)) d.createObjectStore(STORENAME, { keyPath: 'id' });
          };
          req.onsuccess = () => { db = req.result; resolve(db); };
          req.onerror = () => { storageMode = 'localstorage'; resolve(null); };
        });
      }
      function putImageIndexedDB(record) {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_NAME, 'readwrite');
          tx.objectStore(STORE_NAME).put(record);
          tx.oncomplete = () => resolve(true);
          tx.onerror = () => reject(tx.error);
        });
      }
      function getImageIndexedDB(id) {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(STORE_NAME, 'readonly');
          const req = tx.objectStore(STORE_NAME).get(id);
        req.onsuccess = () => resolve(req.result || null);
          req.onerror = () => reject(req.error);
        });
      }
      async function blobToDataURL(blob) {
        return new Promise((resolve,reject)=>{
          const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.onerror=reject; fr.readAsDataURL(blob);
        });
      }
      async function putImage(record) {
        if (storageMode === 'indexeddb') return putImageIndexedDB(record);
        const dataURL = await blobToDataURL(record.blob);
        const payload = { id:record.id, name:record.name, mime:record.mime, dataURL, hash:record.hash };
        localStorage.setItem('img_'+record.id, JSON.stringify(payload));
        return true;
      }
      async function getImage(id) {
        if (storageMode === 'indexeddb') return getImageIndexedDB(id);
        const raw = localStorage.getItem('img_'+id);
        if (!raw) return null;
        const payload = JSON.parse(raw);
        const blob = await (await fetch(payload.dataURL)).blob();
        return { id:payload.id, name:payload.name, mime:payload.mime, blob, hash:payload.hash };
      }

      // ===== Archive locale (JSON) =====
      async function fileToBase64(file) {
        return new Promise((resolve,reject)=>{
          const fr=new FileReader(); fr.onload=()=>resolve(fr.result.split(',')[1]); fr.onerror=reject; fr.readAsDataURL(file);
        });
      }
      function base64ToBlob(b64, mime) {
        const byteChars = atob(b64);
        const len = byteChars.length;
        const bytes = new Uint8Array(len);
        for (let i=0; i<len; i++) bytes[i] = byteChars.charCodeAt(i);
        return new Blob([bytes], { type: mime || 'application/octet-stream' });
      }
      async function buildLocalArchive(files) {
        const items = [];
        for (const f of files) {
          const b64 = await fileToBase64(f);
          items.push({ name: f.name, mime: f.type || 'application/octet-stream', data: b64 });
        }
        return JSON.stringify({ type: 'LOCALARCHIVEv1', createdAt: Date.now(), items });
      }
      async function parseLocalArchive(file) {
        const text = await file.text();
        const obj = JSON.parse(text);
        if (!obj || obj.type !== 'LOCALARCHIVEv1') throw new Error('Archive locale invalide');
        return obj.items.map(it => ({ name: it.name, blob: base64ToBlob(it.data, it.mime) }));
      }

      // ===== Événements UI =====
      (async () => { await openDB(); })();

      // Compresser
      $('makeZipBtn').addEventListener('click', async () => {
        const files = $('zipFiles').files;
        const status = $('zipStatus');
        if (!files || files.length === 0) { html(status, '<p>Aucun fichier sélectionné.</p>'); return; }
        html(status, '<p>Compression en cours...</p>');
        try {
          const json = await buildLocalArchive(files);
          const blob = new Blob([json], { type: 'application/json' });
          const name = 'archive-' + Date.now() + '.zip'; // .zip pour homogénéité
          saveBlob(blob, name);
          html(status, '<p>Archive locale générée: <code class="inline">'+name+'</code></p><p class="note">Tu peux la réouvrir avec le bouton “Décompresser”.</p>');
        } catch (err) {
          console.error(err);
          html(status, '<p class="error">Erreur lors de la compression.</p>');
        }
      });

      // Décompresser
      $('unzipBtn').addEventListener('click', async () => {
        const file = $('zipInput').files && $('zipInput').files[0];
        const result = $('unzipResult');
        if (!file) { html(result, '<p>Aucun fichier d’archive sélectionné.</p>'); return; }
        html(result, '<p>Décompression en cours...</p>');
        try {
          const items = await parseLocalArchive(file);
          const list = document.createElement('ul');
          if (items.length === 0) { html(result, '<p>Aucun fichier dans l’archive locale.</p>'); return; }
          for (const it of items) {
            const url = URL.createObjectURL(it.blob);
            const li = document.createElement('li');
            const a = document.createElement('a'); a.href = url; a.download = it.name; a.textContent = it.name+' (télécharger)';
            a.style.display='inline-block'; a.style.marginRight='10px';
            li.appendChild(a);
            if (/(\.png|\.jpg|\.jpeg|\.gif|\.webp|\.bmp|\.svg)$/i.test(it.name)) {
              const img = document.createElement('img'); img.src=url; img.alt=it.name; img.style.maxWidth='300px'; img.style.display='block'; img.style.marginTop='6px';
              li.appendChild(img);
            }
            list.appendChild(li);
          }
          result.innerHTML = ''; result.appendChild(list);
        } catch (err) {
          console.error(err);
          html(result, '<p class="error">Archive non reconnue. Utilise une archive créée par ce site.</p>');
        }
      });

      // Téléverser imaj pwoteje
      $('saveProtBtn').addEventListener('click', async () => {
        const file = $('protImage').files && $('protImage').files[0];
        const pwd = $('protPwd').value || '';
        const status = $('protStatus');
        if (!file || !pwd) { html(status, '<p>Image et mot de passe sont obligatoires.</p>'); return; }
        html(status, '<p>Enregistrement local en cours...</p>');
        try {
          const id = randomId();
          const hash = await hashPassword(pwd);
          const blob = await file.slice(0, file.size, file.type || 'application/octet-stream');
          await putImage({ id, name: file.name, mime: file.type || 'application/octet-stream', blob, hash });
          html(status, `
            <p>Image protégée créée.</p>
            <p><strong>ID d’accès:</strong></p>
            <div class="id-box">${id}</div>
            <p class="note">Copie l’ID epi kenbe mot de pase a. Yo nesesè pou jwenn aksè.</p>
          `);
          $('protImage').value = ''; $('protPwd').value = '';
        } catch (err) {
          console.error(err);
          html(status, '<p class="error">Erreur lors de l’enregistrement.</p>');
        }
      });

      // Wè imaj pwoteje
      $('viewBtn').addEventListener('click', async () => {
        const id = ($('viewId').value || '').trim();
        const pwd = $('viewPwd').value || '';
        const result = $('viewResult');
        if (!id || !pwd) { html(result, '<p>ID et mot de passe sont requis.</p>'); return; }
        html(result, '<p>Vérification...</p>');
        try {
          const rec = await getImage(id);
          if (!rec) { html(result, '<p>Ressource protégée introuvable.</p>'); return; }
          const hash = await hashPassword(pwd);
          if (hash !== rec.hash) { html(result, '<p>Mot de passe incorrect.</p>'); return; }
          const url = URL.createObjectURL(rec.blob);
          const isImage = /^image\//.test(rec.mime);
          const nameSafe = rec.name || 'image';
          html(result, `
            <p><strong>Nom:</strong> ${nameSafe}</p>
            ${isImage ? <img src="${url}" alt="Image protégée"/> : '<p>Ce fichier n’est pas une image.</p>'}
            <p><a class="btn" href="${url}" download="${nameSafe}">Télécharger</a></p>
          `);
        } catch (err) {
          console.error(err);
          html(result, '<p class="error">Erreur lors de l’accès.</p>');
        }
      });
    </script>
  </body>
</html>
